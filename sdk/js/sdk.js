// Generated by CoffeeScript 1.6.1
var API, SDK,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

API = (function() {

  function API() {}

  /*
  View 函数具体实现
  */


  API.prototype.view = {
    card: function(args) {
      var content, pluginID, title;
      pluginID = args.pluginID, title = args.title, content = args.content;
      $("#cards ." + pluginID + " .title").html(title);
      return $("#cards ." + pluginID + " .content").html(content);
    }
  };

  /*
  User 函数具体实现
  */


  API.prototype.user = {
    stuid: function() {
      return {
        data: "3000000000"
      };
    },
    pwd: function() {
      return {
        data: "123456"
      };
    }
  };

  /*
  KVDB 函数具体实现
  */


  API.prototype.kvdb = {
    get: function(args) {
      var key, msg;
      key = args.key;
      msg = {};
      try {
        msg.data = localStorage.getItem(key);
      } catch (e) {
        msg.error = e;
      }
      return msg;
    },
    set: function(args) {
      var key, msg, value;
      key = args.key, value = args.value;
      msg = {};
      try {
        msg.data = localStorage.setItem(key, value);
      } catch (e) {
        msg.error = e;
      }
      return msg;
    },
    remove: function(args) {
      var key, msg;
      key = args.key;
      msg = {};
      try {
        msg.data = localStorage.removeItem(key);
      } catch (e) {
        msg.error = e;
      }
      return msg;
    },
    clear: function(args) {
      var msg;
      msg = {};
      try {
        msg.data = localStorage.clear();
      } catch (e) {
        msg.error = e;
      }
      return msg;
    }
  };

  return API;

})();

$(function() {
  var pluginID, sdk;
  $(window).on('hashchange', function() {
    return window.location.reload();
  });
  pluginID = window.location.hash.replace(new RegExp('#', 'g'), '');
  if (pluginID.length < 1) {
    return window.location.hash = 'qiuShiGou';
  } else {
    return sdk = new SDK(pluginID);
  }
});

SDK = (function(_super) {

  __extends(SDK, _super);

  /*
  @param {String} pluginID pluginID
  @param {Boolean} debug debug
  */


  function SDK(pluginID, debug) {
    this.pluginID = pluginID;
    this.debug = debug != null ? debug : true;
    console.log("Starting QSC Mobile Plugin SDK");
    this.background();
    this.section();
  }

  /*
  重载 iframe 沙盒 #iframeID 中的API
  
  @param {String} iframeID iframID
  */


  SDK.prototype.overloadAPI = function(iframeID) {
    var obj, prop, win,
      _this = this;
    win = document.getElementById(iframeID).contentWindow;
    obj = win.Object;
    if (!obj.prototype.watch) {
      prop = {
        enumerable: false,
        configurable: true,
        writable: false,
        value: function(prop, handle) {
          var getter, newval, oldval, setter;
          oldval = this.prop;
          newval = oldval;
          getter = function() {
            return newval;
          };
          setter = function(val) {
            oldval = newval;
            return newval = handle.call(this, prop, oldval, val);
          };
          return obj.defineProperty(this, prop, {
            get: getter,
            set: setter,
            enumerable: true,
            configurable: true
          });
        }
      };
      obj.defineProperty(obj.prototype, "watch", prop);
    }
    return win.watch('Platform', function(prop, oldval, val) {
      val.prototype.sendRequest = function(request) {
        var args, callbackName, error, errorFn, fn, random, success;
        fn = request.fn, args = request.args, success = request.success, error = request.error;
        errorFn = error;
        random = (Math.random() + '').replace(new RegExp('0\.', ''), '');
        callbackName = "QSCMobile" + random + "_" + (new Date().getTime());
        win[callbackName] = function(data) {
          var _ref;
          _ref = data, data = _ref.data, error = _ref.error;
          if (error) {
            return typeof errorFn === "function" ? errorFn(error) : void 0;
          } else {
            return typeof success === "function" ? success(data) : void 0;
          }
        };
        return _this.onRequest(win, {
          fn: fn,
          args: args,
          callback: callbackName
        });
      };
      return val;
    });
  };

  /*
  在 iframe 沙盒 #background 中执行插件的 Background.js
  */


  SDK.prototype.background = function() {
    var iframe, src;
    src = "background.html#" + this.pluginID;
    iframe = $('<iframe id="background" height="450" width="300" src="' + src + '"></iframe>')[0];
    $('body').append(iframe);
    return this.overloadAPI('background');
  };

  /*
  显示 Card
  */


  SDK.prototype.card = function() {};

  /*
  在 iframe 沙盒 #section 中运行插件的Section视图
  */


  SDK.prototype.section = function() {
    var iframe, src;
    src = "../plugins/" + this.pluginID + "/index.html";
    iframe = $('<iframe id="section" height="450" width="300" src="' + src + '"></iframe>')[0];
    iframe.onload = function() {
      var style;
      style = $('<link href="../../sdk/css/scrollbar.css" rel="stylesheet" type="text/css">')[0];
      style.onload = function() {
        var scrollbarWidth, width;
        width = $('#section').contents().find('html').width();
        scrollbarWidth = 300 - width;
        $('#wrap').css({
          width: width,
          'padding-left': scrollbarWidth
        });
        return $('#wrap').animate({
          opacity: 1
        });
      };
      return $('#section').contents().find('head').append(style);
    };
    $('#wrap').html(iframe);
    return this.overloadAPI('section');
  };

  /*
  Request 处理
  
  @param {Object} request 请求
  */


  SDK.prototype.onRequest = function(win, request) {
    var args, callback, data, fn, json, part1, part2, _ref;
    fn = request.fn, args = request.args, callback = request.callback;
    console.log("\n\nQSCMobile-Plugins-API-Request-ID: " + callback);
    json = JSON.stringify({
      fn: fn,
      args: args
    }, null, 4);
    if (this.debug) {
      console.log("\nRequest: " + json);
    }
    _ref = fn.split('.'), part1 = _ref[0], part2 = _ref[1];
    fn = this[part1][part2];
    data = fn.call(this, args);
    json = JSON.stringify({
      data: data.data,
      error: data.error
    }, null, 4);
    if (this.debug) {
      console.log("\nResults: " + json);
    }
    return typeof win[callback] === "function" ? win[callback](data) : void 0;
  };

  return SDK;

})(API);
